{% extends "products/base.html" %}
{% load i18n %}

{% block products_content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="fw-bold">{% trans "Products List" %}</h3>
    <div>
      <a href="{% url 'products:new_product' %}" class="btn btn-primary me-2">
        <i class="bi bi-plus-circle"></i> {% trans "Add Product" %}
      </a>
      <form id="barcodeForm" method="get" action="{% url 'products:print_multiple_barcodes' %}" class="d-inline">
        <button type="submit" class="btn btn-success">
          üñ®Ô∏è {% trans "Print Selected Barcodes" %}
        </button>
      </form>
    </div>
  </div>

  <!-- üîç ŸÖÿ±ÿ®ÿπ ÿßŸÑÿ®ÿ≠ÿ´ -->
  <div class="mb-3">
    <input type="text" id="searchInput" class="form-control" placeholder="{% trans 'Search products...' %}">
  </div>

  <!-- üßæ ÿ¨ÿØŸàŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ -->
  <div class="table-responsive shadow-sm">
    <table class="table table-hover align-middle text-center">
      <thead class="table-primary">
        <tr>
          <th><input type="checkbox" id="selectAll"></th>
          <th>{% trans "Image" %}</th>
          <th>{% trans "Name" %}</th>
          <th>{% trans "SKU" %}</th>
          <th>{% trans "Category" %}</th>
          <th>{% trans "Type" %}</th>
          <th>{% trans "Price" %}</th>
          <!-- üßÆ ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÉŸÖŸäÿ© ŸÖÿπ ÿ≤ÿ± ÿßŸÑŸÅÿ±ÿ≤ -->
          <th id="sortOnHand" style="cursor:pointer;">
            {% trans "On Hand" %} <span id="sortIcon">‚¨ç</span>
          </th>
          <th>{% trans "Actions" %}</th>
        </tr>
      </thead>

      <tbody id="productsTable">
        {% for p in products %}
        <tr>
          <td><input type="checkbox" name="ids" form="barcodeForm" value="{{ p.id }}"></td>

          <td>
            {% if p.image %}
              <img src="{{ p.image.url }}" class="rounded" width="60" height="60" style="object-fit: cover;">
            {% else %}
              <span class="text-muted">‚Äî</span>
            {% endif %}
          </td>

          <td class="fw-semibold">{{ p.name }}</td>
          <td><span class="text-muted small">{{ p.sku }}</span></td>

          <td>
            {% if p.category %}
              <span class="badge bg-info text-dark">
                {% if p.category.parent %}
                  {{ p.category.parent.name }} ‚Ä∫ {{ p.category.name }}
                {% else %}
                  {{ p.category.name }}
                {% endif %}
              </span>
            {% else %}
              <span class="text-muted">‚Äî</span>
            {% endif %}
          </td>

          <td>
            {% if p.product_type == "inventory" %}
              <span class="badge bg-success">{% trans "Inventory" %}</span>
            {% elif p.product_type == "notinventory" %}
              <span class="badge bg-secondary">{% trans "Non-Inventory" %}</span>
            {% else %}
              <span class="badge bg-warning text-dark">{% trans "Service" %}</span>
            {% endif %}
          </td>

          <td>{{ p.price|floatformat:2 }}</td>

          <td>
            {% if p.product_type == "inventory" %}
              <span class="on-hand">{{ p.on_hand }}</span>
            {% else %}
              <span class="text-muted">‚Äî</span>
            {% endif %}
          </td>

          <td>
            <a href="{% url 'products:edit_product' p.id %}" class="btn btn-outline-warning btn-sm">
              ‚úèÔ∏è {% trans "Edit" %}
            </a>
            <a href="{% url 'products:print_barcode' p.id %}" class="btn btn-outline-primary btn-sm">
              üñ®Ô∏è {% trans "Barcode" %}
            </a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="9" class="text-center text-muted py-3">
            {% trans "No products found." %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- ‚öôÔ∏è ÿ≥ŸÉÿ±Ÿäÿ®ÿ™ÿßÿ™ -->
<script>
  // üîç ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±
  document.getElementById('searchInput').addEventListener('keyup', function() {
    const filter = this.value.toLowerCase();
    const rows = document.querySelectorAll('#productsTable tr');
    rows.forEach(row => {
      const text = row.innerText.toLowerCase();
      row.style.display = text.includes(filter) ? '' : 'none';
    });
  });

  // ‚úÖ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÉŸÑ
  document.getElementById('selectAll').addEventListener('change', function(e) {
    const checkboxes = document.querySelectorAll('input[name="ids"]');
    checkboxes.forEach(cb => cb.checked = e.target.checked);
  });

  // üîÑ ŸÅÿ±ÿ≤ ÿ≠ÿ≥ÿ® ÿßŸÑŸÉŸÖŸäÿ© (On Hand)
  let sortAsc = true;
  document.getElementById('sortOnHand').addEventListener('click', function() {
    const table = document.getElementById('productsTable');
    const rows = Array.from(table.querySelectorAll('tr'));
    rows.sort((a, b) => {
      const aVal = parseFloat(a.querySelector('.on-hand')?.innerText || 0);
      const bVal = parseFloat(b.querySelector('.on-hand')?.innerText || 0);
      return sortAsc ? bVal - aVal : aVal - bVal;
    });
    sortAsc = !sortAsc;
    document.getElementById('sortIcon').textContent = sortAsc ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è';
    table.innerHTML = '';
    rows.forEach(r => table.appendChild(r));
  });
</script>
{% endblock %}
